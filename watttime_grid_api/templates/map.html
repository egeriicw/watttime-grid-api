{% load leaflet_tags %}
{% load staticfiles %}
<html>
  <head>
    <script src='{% static "rest_framework_swagger/lib/jquery-1.8.0.min.js" %}' type='text/javascript'></script>
   {% leaflet_js %}
   {% leaflet_css %}
	<style>
		.map {
			width: 800px;
			height: 500px;
		}

		.info {
			padding: 6px 8px;
			font: 14px/16px Arial, Helvetica, sans-serif;
			background: white;
			background: rgba(255,255,255,0.8);
			box-shadow: 0 0 15px rgba(0,0,0,0.2);
			border-radius: 5px;
		}
		.info h4 {
			margin: 0 0 5px;
			color: #777;
		}

		.legend {
			text-align: left;
			line-height: 20px;
			color: #555;
		}
		.legend i {
			width: 18px;
			height: 18px;
			float: left;
			margin-right: 8px;
			opacity: 0.7;
		}
	</style>
  </head>
  <body>
    <h1>Weather Stations</h1>
   {% leaflet_map "map" callback="main_map_init" creatediv=False %}
   <div id="map" style="height: 500px;"></div>

    <script type="text/javascript">
        function getColor(val) {
            return val > 1800  ? 'rgb(215,25,28)'   :
                   val > 1200  ? 'rgb(253,174,97)'  :
                   val > 600   ? 'rgb(166,217,106)' :
                   val > 0     ? 'rgb(26,150,65)'   :
                                 'rgb(50,50,50)';
        }

        function style(feature) {
            return {
                fillColor: getColor(feature.properties.carbon),
                weight: 2,
                opacity: 1,
                color: 'white',
                dashArray: '3',
                fillOpacity: 0.7
            };
        }

        function onEachFeature (feature, layer) {
            var msg = feature.properties.name+"<br>";
            if (feature.properties.carbon > 0) {
                msg += "carbon impact = "+feature.properties.carbon+" lb/MW<br>";
                msg += feature.properties.lag+" minutes ago";
            } else {
                msg += "no impact data available";
            }
            layer.bindPopup(msg);
        }        

        function main_map_init (map, options) {
            // set size
		//var map = L.map('map');
            map.setView([37.8, -96], 4);

            // Add GeoJSON layer
            var data = {{ geojson|safe }};
            L.geoJson(data, {
                style: style,
                onEachFeature: onEachFeature,
            }).addTo(map);

            // add legend
		var legend = L.control({position: 'bottomright'});
		legend.onAdd = function (map) {
                	var div = L.DomUtil.create('div', 'info legend'),
                        labels = [],
				from, to;
                  labels.push('<i style="background:' + getColor(-1) + '"></i> ' +
					'no carbon data');
                  labels.push('<i style="background:' + getColor(1) + '"></i> ' +
					'0-600 lb CO2/MW');
                  labels.push('<i style="background:' + getColor(601) + '"></i> ' +
					'600-1200 lb CO2/MW');
                  labels.push('<i style="background:' + getColor(1201) + '"></i> ' +
					'1200-1800 lb CO2/MW');
                  labels.push('<i style="background:' + getColor(2001) + '"></i> ' +
					'1800+ lb CO2/MW');

			div.innerHTML = labels.join('<br>');
			return div;
		};
		legend.addTo(map);
        }
    </script> 
  </body>
</html>